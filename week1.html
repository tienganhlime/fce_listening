<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FCE Listening Week 1 - Trung T√¢m Ti·∫øng Anh LIME</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 50%, #81C784 100%);
        }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4CAF50;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .correct-answer { background-color: #C8E6C9 !important; border-color: #4CAF50 !important; }
        .wrong-answer { background-color: #FFCDD2 !important; border-color: #F44336 !important; }
/* TƒÉng c·ª° ch·ªØ options */
label span {
    font-size: 17px;
}
/* TƒÉng c·ª° ch·ªØ instructions */
#instructions p,
.text-sm {
    font-size: 16px !important;
}
    </style>
</head>
<body>

<!-- M√†n h√¨nh nh·∫≠p m√£ -->
<div id="codeScreen" class="min-h-screen p-4 fade-in">
    <div class="max-w-2xl mx-auto">
        <div class="bg-white rounded-2xl shadow-2xl p-8 mt-8">
            <div class="text-center mb-8">
                <img src="https://gofirst.pro/images/uploads/62/baseimg/logo_16541442053.png" 
                     alt="LIME Logo" class="w-32 h-32 mx-auto mb-4 object-contain">
                <h1 class="text-4xl font-bold text-green-700 mb-2">Trung T√¢m Ti·∫øng Anh LIME</h1>
                <p class="text-green-600 text-lg">Hotline: 0976222792</p>
                <div class="mt-4 h-1 w-32 bg-green-500 mx-auto rounded"></div>
            </div>
            
            <div class="bg-green-50 rounded-xl p-6 mb-6">
                <h2 class="text-2xl font-bold text-green-800 mb-4">FCE LISTENING - WEEK 1</h2>
                <div class="space-y-2 text-green-700">
                    <p>üéß Part 2: Family Holiday (5 c√¢u matching)</p>
                    <p>üéß Part 4: Interview with Tyler Williams (7 c√¢u multiple choice)</p>
                    <p>‚è∞ Audio c√≥ th·ªÉ t·∫°m d·ª´ng/nghe l·∫°i</p>
                    <p>‚úÖ Ch·∫•m ƒëi·ªÉm t·ª± ƒë·ªông</p>
                    <p>üìä Theo d√µi ti·∫øn ƒë·ªô h·ªçc t·∫≠p</p>
                </div>
            </div>

            <div class="bg-yellow-50 border-2 border-yellow-300 rounded-xl p-4 mb-6">
                <div class="flex items-start gap-2">
                    <svg class="w-6 h-6 text-yellow-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                    <div class="text-yellow-800 text-sm">
                        <p class="font-bold mb-1">‚ö†Ô∏è L∆∞u √Ω:</p>
                        <p>‚Ä¢ C√≥ th·ªÉ tua/d·ª´ng/nghe l·∫°i audio</p>
                        <p>‚Ä¢ H·ªá th·ªëng s·∫Ω ghi nh·∫≠n c√°c l·∫ßn nghe l·∫°i</p>
                        <p>‚Ä¢ C√≥ th·ªÉ l√†m l·∫°i nhi·ªÅu l·∫ßn</p>
                    </div>
                </div>
            </div>

            <div>
                <label class="block text-green-800 font-semibold mb-2">M√£ h·ªçc sinh *</label>
                <input type="text" id="studentCode" 
                    class="w-full px-4 py-3 border-2 border-green-300 rounded-lg focus:border-green-500 focus:outline-none uppercase"
                    placeholder="Nh·∫≠p m√£ h·ªçc sinh (VD: HS001)">
            </div>

            <button onclick="verifyStudent()" 
                class="w-full mt-6 bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-lg transition duration-300 text-lg shadow-lg">
                X√ÅC NH·∫¨N & B·∫ÆT ƒê·∫¶U
            </button>
        </div>
    </div>
</div>

<!-- M√†n h√¨nh l√†m b√†i -->
<div id="testScreen" class="hidden min-h-screen p-4 pb-32">
    <div class="max-w-5xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-2xl shadow-2xl p-6 mb-6 sticky top-4 z-10">
            <div class="flex justify-between items-center flex-wrap gap-4">
                <div class="flex items-center gap-3">
                    <img src="https://gofirst.pro/images/uploads/62/baseimg/logo_16541442053.png" 
                         alt="LIME Logo" class="w-12 h-12 object-contain">
                    <div>
                        <h1 class="text-2xl font-bold text-green-700">FCE Listening - Week 1</h1>
                        <p class="text-green-600 text-sm">Parts 2 & 4</p>
                    </div>
                </div>
                
                <div class="text-right">
                    <p class="text-sm text-gray-600">H·ªçc sinh: <span id="headerName"></span></p>
                    <p class="text-sm text-gray-600">M√£: <span id="headerCode"></span></p>
                </div>
            </div>
            
            <div class="mt-4">
                <div class="flex justify-between text-sm text-gray-600 mb-1">
                    <span>Ti·∫øn ƒë·ªô: <span id="progress">0</span>/12 c√¢u</span>
                    <span id="progressPercent">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3">
                    <div id="progressBar" class="bg-green-600 h-3 rounded-full transition-all" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- PART 2 -->
        <div class="bg-white rounded-2xl shadow-2xl p-8 mb-6">
            <div class="bg-blue-600 text-white px-6 py-3 rounded-t-xl -mx-8 -mt-8 mb-6">
                <h2 class="text-2xl font-bold">PART 2 - Family Holiday</h2>
                <p class="text-sm opacity-90">Questions 1-5 (5 c√¢u)</p>
            </div>

            <!-- Audio Player Part 2 -->
            <div class="bg-green-50 rounded-xl p-4 mb-6">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-lg font-bold text-green-700">üéß Audio Part 2</h3>
                    <span id="replayCount2" class="text-sm text-gray-600">Nghe l·∫°i: 0 l·∫ßn</span>
                </div>
                <audio id="audio2" controls class="w-full mb-2">
                    <source src="YOUR_AUDIO_PART2_URL_HERE" type="audio/mpeg">
                </audio>
                <div id="audioTime2" class="text-sm text-gray-600 text-center">00:00 / 00:00</div>
            </div>

            <!-- Instructions Part 2 -->
            <div class="bg-blue-50 border-l-4 border-blue-600 p-4 mb-6">
                <h3 class="font-bold text-blue-800 mb-2">üìã Instructions:</h3>
                <p class="text-blue-700 text-sm mb-2">You will hear five short extracts in which teenagers describe their favourite family holiday. For questions 1-5, choose from the list (A-H) what each speaker says about the holiday. Use the letters only once. There are three extra letters which you do not need to use.</p>
            </div>

            <!-- Options A-H -->
            <div class="bg-gray-50 rounded-xl p-4 mb-6">
                <h4 class="font-bold text-gray-800 mb-3">Options (A-H):</h4>
                <div class="grid grid-cols-1 gap-2 text-sm">
                    <p><span class="font-bold text-green-700">A</span> - I regret arguing on holiday.</p>
                    <p><span class="font-bold text-green-700">B</span> - I'm going to try to have the same experience but with different people.</p>
                    <p><span class="font-bold text-green-700">C</span> - I felt more independent on this trip.</p>
                    <p><span class="font-bold text-green-700">D</span> - I enjoyed the holiday because we stayed in a posh hotel.</p>
                    <p><span class="font-bold text-green-700">E</span> - I wish I had done more on this holiday.</p>
                    <p><span class="font-bold text-green-700">F</span> - My enjoyment of this holiday largely relied on us having good weather.</p>
                    <p><span class="font-bold text-green-700">G</span> - I am fortunate that this trip was captured on film.</p>
                    <p><span class="font-bold text-green-700">H</span> - I didn't enjoy the holiday when it rained.</p>
                </div>
            </div>

            <!-- Questions 1-5 -->
            <div id="part2Container" class="space-y-6"></div>
        </div>

        <!-- PART 4 -->
        <div class="bg-white rounded-2xl shadow-2xl p-8 mb-6">
            <div class="bg-purple-600 text-white px-6 py-3 rounded-t-xl -mx-8 -mt-8 mb-6">
                <h2 class="text-2xl font-bold">PART 4 - Interview with Tyler Williams</h2>
                <p class="text-sm opacity-90">Questions 6-12 (7 c√¢u)</p>
            </div>

            <!-- Audio Player Part 4 -->
            <div class="bg-green-50 rounded-xl p-4 mb-6">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-lg font-bold text-green-700">üéß Audio Part 4</h3>
                    <span id="replayCount4" class="text-sm text-gray-600">Nghe l·∫°i: 0 l·∫ßn</span>
                </div>
                <audio id="audio4" controls class="w-full mb-2">
                    <source src="YOUR_AUDIO_PART4_URL_HERE" type="audio/mpeg">
                </audio>
                <div id="audioTime4" class="text-sm text-gray-600 text-center">00:00 / 00:00</div>
            </div>

            <!-- Instructions Part 4 -->
            <div class="bg-purple-50 border-l-4 border-purple-600 p-4 mb-6">
                <h3 class="font-bold text-purple-800 mb-2">üìã Instructions:</h3>
                <p class="text-purple-700 text-sm">You will hear an interview with Tyler Williams, a professional dancer. For questions 6-12, choose the best answer (A, B or C).</p>
            </div>

            <!-- Questions 6-12 -->
            <div id="part4Container" class="space-y-6"></div>
        </div>

        <!-- Submit Button -->
        <div class="bg-white rounded-2xl shadow-2xl p-8">
            <div id="warningBox" class="hidden mb-4 p-4 bg-yellow-50 border-2 border-yellow-300 rounded-lg">
                <p class="text-yellow-800 text-sm">
                    ‚ö†Ô∏è B·∫°n c√≤n <span id="unansweredCount">12</span> c√¢u ch∆∞a tr·∫£ l·ªùi!
                </p>
            </div>
            
            <button onclick="submitTest()" id="submitBtn"
                class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-lg transition text-xl shadow-lg">
                N·ªòP B√ÄI
            </button>
        </div>
    </div>
</div>

<!-- M√†n h√¨nh k·∫øt qu·∫£ -->
<div id="resultScreen" class="hidden min-h-screen p-4">
    <div class="max-w-5xl mx-auto">
        <div class="bg-white rounded-2xl shadow-2xl p-8 mt-8 fade-in">
            <div class="text-center mb-6">
                <img src="https://gofirst.pro/images/uploads/62/baseimg/logo_16541442053.png" 
                     alt="LIME Logo" class="w-32 h-32 mx-auto mb-4 object-contain">
                <h1 class="text-3xl font-bold text-green-700 mb-2">Trung T√¢m Ti·∫øng Anh LIME</h1>
            </div>

            <div class="text-center mb-8">
                <svg class="w-24 h-24 text-green-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <h2 class="text-3xl font-bold text-green-800 mb-4">N·ªôp b√†i th√†nh c√¥ng!</h2>
            </div>

            <!-- K·∫øt qu·∫£ t·ªïng quan -->
            <div class="bg-green-50 rounded-xl p-6 mb-6 border-2 border-green-200">
                <div class="grid grid-cols-3 gap-4 text-center">
                    <div>
                        <p class="text-gray-600">ƒêi·ªÉm s·ªë</p>
                        <p id="resultScore" class="text-3xl font-bold text-green-700">0%</p>
                    </div>
                    <div>
                        <p class="text-gray-600">C√¢u ƒë√∫ng</p>
                        <p id="resultCorrect" class="text-3xl font-bold text-green-700">0/12</p>
                    </div>
                    <div>
                        <p class="text-gray-600">Th·ªùi gian</p>
                        <p id="resultTime" class="text-2xl font-bold text-green-700">0 ph√∫t</p>
                    </div>
                </div>
            </div>

            <!-- Danh s√°ch c√¢u sai -->
            <div class="bg-red-50 rounded-xl p-4 mb-6 border-2 border-red-200">
                <h3 class="font-bold text-red-800 mb-2">‚ùå C√°c c√¢u tr·∫£ l·ªùi sai:</h3>
                <p id="wrongList" class="text-red-700"></p>
            </div>

            <!-- Th·ªëng k√™ nghe l·∫°i -->
            <div class="bg-blue-50 rounded-xl p-4 mb-6 border-2 border-blue-200">
                <h3 class="font-bold text-blue-800 mb-2">üîÑ Th·ªëng k√™ nghe l·∫°i:</h3>
                <div id="resultReplayLog" class="text-blue-700 text-sm"></div>
            </div>

            <!-- Hi·ªÉn th·ªã l·∫°i to√†n b·ªô b√†i l√†m -->
            <div class="bg-white rounded-xl p-6 mb-6 border-2 border-gray-200">
                <h3 class="text-2xl font-bold text-gray-800 mb-4 text-center">üìù B√ÄI L√ÄM C·ª¶A B·∫†N</h3>
                <div id="reviewContainer" class="space-y-6"></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button onclick="location.reload()" 
                    class="bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-lg transition shadow-lg">
                    V·ªÅ trang ch·ªß
                </button>
                <button onclick="location.reload()" 
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-lg transition shadow-lg">
                    L√†m b√†i ti·∫øp
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// ========== C·∫§U H√åNH ==========
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz-TjOgHmqjHO3K_uDW7djeGQ4F85S1HDiTkAMVhZm2E21gaAQHSueFA-gvgoPLEzTb/exec';
const WEEK_NUMBER = 1;

// Part 2 Configuration
const PART2_CONFIG = {
    title: 'Part 2 - Family Holiday',
    audioUrl: 'https://res.cloudinary.com/dzby0c2up/video/upload/v1762504614/COMPLETE_FIRST_fS_WB_002_nclmm2.mp3',
    questions: [
        { num: 1, text: 'Speaker 1', type: 'choice', options: { A: 'A', B: 'B', C: 'C', D: 'D', E: 'E', F: 'F', G: 'G', H: 'H' } },
        { num: 2, text: 'Speaker 2', type: 'choice', options: { A: 'A', B: 'B', C: 'C', D: 'D', E: 'E', F: 'F', G: 'G', H: 'H' } },
        { num: 3, text: 'Speaker 3', type: 'choice', options: { A: 'A', B: 'B', C: 'C', D: 'D', E: 'E', F: 'F', G: 'G', H: 'H' } },
        { num: 4, text: 'Speaker 4', type: 'choice', options: { A: 'A', B: 'B', C: 'C', D: 'D', E: 'E', F: 'F', G: 'G', H: 'H' } },
        { num: 5, text: 'Speaker 5', type: 'choice', options: { A: 'A', B: 'B', C: 'C', D: 'D', E: 'E', F: 'F', G: 'G', H: 'H' } }
    ]
};

// Part 4 Configuration
const PART4_CONFIG = {
    title: 'Part 4 - Interview with Tyler Williams',
    audioUrl: 'https://res.cloudinary.com/dzby0c2up/video/upload/v1762504586/COMPLETE_FIRST_fS_WB_003_cjuppq.mp3',
    questions: [
        { 
            num: 6, 
            text: 'Why was Tyler interested in dancing as a child?', 
            type: 'choice', 
            options: { 
                A: 'Dancing had always been in his family.', 
                B: 'He enjoyed watching dancers on the street.', 
                C: 'He was influenced by watching movies.' 
            } 
        },
        { 
            num: 7, 
            text: 'Tyler started giving street performances', 
            type: 'choice', 
            options: { 
                A: 'to practise the moves he had learnt as a child.', 
                B: 'to earn some extra money.', 
                C: 'because his friend suggested it.' 
            } 
        },
        { 
            num: 8, 
            text: 'How did Tyler react at first when his friend posted one of his dance performances online?', 
            type: 'choice', 
            options: { 
                A: 'He was very angry with him for doing this.', 
                B: 'He was happy that his sister liked his performance.', 
                C: 'It confirmed how he felt about his ability.' 
            } 
        },
        { 
            num: 9, 
            text: 'How did Tyler\'s parents feel about his choice of career? They felt', 
            type: 'choice', 
            options: { 
                A: 'excited for him, as they realised he had the potential to do well.', 
                B: 'worried about Tyler being able to always find work.', 
                C: 'lucky, because their son was so talented.' 
            } 
        },
        { 
            num: 10, 
            text: 'What was the main reason Tyler enjoyed attending the academy?', 
            type: 'choice', 
            options: { 
                A: 'He learnt new dance styles, such as ballet and tap.', 
                B: 'He developed his own dance style even more.', 
                C: 'He was encouraged to invent his own dances.' 
            } 
        },
        { 
            num: 11, 
            text: 'Tyler had practice performing outside of the school because', 
            type: 'choice', 
            options: { 
                A: 'the academy wanted to encourage Tyler even more.', 
                B: 'the academy had a good relationship with other dance schools.', 
                C: 'the academy had a good relationship with venues in the nearby area.' 
            } 
        },
        { 
            num: 12, 
            text: 'After graduating, Tyler feels lucky because he', 
            type: 'choice', 
            options: { 
                A: 'gets to tour around the country.', 
                B: 'has always had a job.', 
                C: 'because he is starring in a West End show.' 
            } 
        }
    ]
};

// Correct Answers
const correctAnswers = {
    1: 'B', 2: 'H', 3: 'C', 4: 'F', 5: 'D',
    6: 'B', 7: 'B', 8: 'A', 9: 'A', 10: 'C', 11: 'B', 12: 'A'
};

// ========== BI·∫æN TO√ÄN C·ª§C ==========
let studentInfo = {};
let answers = {};
let startTime;
let audio2 = null, audio4 = null;
let lastPos2 = 0, lastPos4 = 0;
let seekCount2 = 0, seekCount4 = 0;
let replayLog2 = [], replayLog4 = [];

// ========== X√ÅC TH·ª∞C H·ªåC SINH ==========
async function verifyStudent() {
    const code = document.getElementById('studentCode').value.trim().toUpperCase();
    if (!code) {
        alert('Vui l√≤ng nh·∫≠p m√£ h·ªçc sinh!');
        return;
    }
    
    try {
        const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=verify&code=${code}`);
        const data = await response.json();
        
        if (data.exists) {
            studentInfo = { code: code, name: data.studentName };
            document.getElementById('codeScreen').classList.add('hidden');
            document.getElementById('testScreen').classList.remove('hidden');
            document.getElementById('headerName').textContent = data.studentName;
            document.getElementById('headerCode').textContent = code;
            
            loadLesson();
            startTime = new Date();
        } else {
            alert('‚ùå M√£ h·ªçc sinh kh√¥ng t·ªìn t·∫°i!');
        }
    } catch (error) {
        alert('L·ªói k·∫øt n·ªëi! Vui l√≤ng th·ª≠ l·∫°i.');
    }
}

// ========== T·∫¢I B√ÄI H·ªåC ==========
function loadLesson() {
    audio2 = document.getElementById('audio2');
    audio4 = document.getElementById('audio4');
    
    audio2.addEventListener('timeupdate', () => trackAudio(audio2, 'audioTime2', 2));
    audio4.addEventListener('timeupdate', () => trackAudio(audio4, 'audioTime4', 4));
    
    audio2.addEventListener('seeked', () => logReplay(2));
    audio4.addEventListener('seeked', () => logReplay(4));
    
    renderQuestions();
}

// ========== RENDER C√ÇU H·ªéI ==========
function renderQuestions() {
    renderPart2();
    renderPart4();
}

function renderPart2() {
    const container = document.getElementById('part2Container');
    let html = '';
    
    PART2_CONFIG.questions.forEach((q) => {
        html += `
        <div class="border-2 border-blue-200 rounded-xl p-6 bg-blue-50" id="question-${q.num}">
            <div class="flex gap-4">
                <div class="flex-shrink-0">
                    <div class="w-10 h-10 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold">
                        ${q.num}
                    </div>
                </div>
                <div class="flex-1">
                    <p class="text-gray-800 mb-4 text-lg font-semibold">${q.text}</p>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
        `;
        
        Object.entries(q.options).forEach(([key, value]) => {
            html += `
                <label class="flex items-center gap-2 p-3 rounded-lg cursor-pointer transition-all bg-white border-2 border-gray-300 hover:bg-blue-50 answer-option" data-question="${q.num}" data-answer="${key}">
                    <input type="radio" name="q${q.num}" value="${key}" onchange="handleAnswer(${q.num}, '${key}')" class="w-4 h-4 text-blue-600">
                    <span class="font-bold text-blue-700">${key}</span>
                </label>
            `;
        });
        
        html += '</div></div></div></div>';
    });
    
    container.innerHTML = html;
}

function renderPart4() {
    const container = document.getElementById('part4Container');
    let html = '';
    
    PART4_CONFIG.questions.forEach((q) => {
        html += `
        <div class="border-2 border-purple-200 rounded-xl p-6 bg-purple-50" id="question-${q.num}">
            <div class="flex gap-4">
                <div class="flex-shrink-0">
                    <div class="w-10 h-10 bg-purple-600 text-white rounded-full flex items-center justify-center font-bold">
                        ${q.num}
                    </div>
                </div>
                <div class="flex-1">
                    <p class="text-gray-800 mb-4 text-lg font-semibold">${q.text}</p>
                    <div class="space-y-2">
        `;
        
        Object.entries(q.options).forEach(([key, value]) => {
            html += `
                <label class="flex items-start gap-3 p-4 rounded-lg cursor-pointer transition-all bg-white border-2 border-gray-300 hover:bg-purple-50 answer-option" data-question="${q.num}" data-answer="${key}">
                    <input type="radio" name="q${q.num}" value="${key}" onchange="handleAnswer(${q.num}, '${key}')" class="mt-1 w-5 h-5 text-purple-600">
                    <span class="flex-1 text-gray-700"><span class="font-semibold text-purple-700">${key}.</span> ${value}</span>
                </label>
            `;
        });
        
        html += '</div></div></div></div>';
    });
    
    container.innerHTML = html;
}

// ========== X·ª¨ L√ù TR·∫¢ L·ªúI ==========
function handleAnswer(questionNum, answer) {
    answers[questionNum] = answer;
    updateProgress();
    
    const labels = document.querySelectorAll(`label[data-question="${questionNum}"]`);
    labels.forEach(label => {
        if (label.dataset.answer === answer) {
            label.classList.remove('bg-white', 'border-gray-300');
            if (questionNum <= 5) {
                label.classList.add('bg-blue-100', 'border-blue-500');
            } else {
                label.classList.add('bg-purple-100', 'border-purple-500');
            }
        } else {
            if (questionNum <= 5) {
                label.classList.remove('bg-blue-100', 'border-blue-500');
            } else {
                label.classList.remove('bg-purple-100', 'border-purple-500');
            }
            label.classList.add('bg-white', 'border-gray-300');
        }
    });
}

function updateProgress() {
    const answered = Object.keys(answers).length;
    const percent = Math.round((answered / 12) * 100);
    document.getElementById('progress').textContent = answered;
    document.getElementById('progressPercent').textContent = percent + '%';
    document.getElementById('progressBar').style.width = percent + '%';
    
    const unanswered = 12 - answered;
    if (unanswered > 0) {
        document.getElementById('warningBox').classList.remove('hidden');
        document.getElementById('unansweredCount').textContent = unanswered;
    } else {
        document.getElementById('warningBox').classList.add('hidden');
    }
}

// ========== AUDIO CONTROL ==========
function trackAudio(audioEl, timeId, partNum) {
    if (!audioEl) return;
    const current = formatTime(audioEl.currentTime);
    const duration = formatTime(audioEl.duration);
    document.getElementById(timeId).textContent = `${current} / ${duration}`;
    
    if (partNum === 2) lastPos2 = audioEl.currentTime;
    if (partNum === 4) lastPos4 = audioEl.currentTime;
}

function logReplay(partNum) {
    const audioEl = partNum === 2 ? audio2 : audio4;
    const lastPos = partNum === 2 ? lastPos2 : lastPos4;
    
    if (!audioEl || audioEl.currentTime === 0) return;
    
    const currentPos = audioEl.currentTime;
    if (Math.abs(currentPos - lastPos) > 3) {
        if (partNum === 2) {
            seekCount2++;
            const logEntry = `Part 2 - L·∫ßn ${seekCount2}: T·ª´ ${formatTime(lastPos)} ‚Üí ${formatTime(currentPos)}`;
            replayLog2.push(logEntry);
            document.getElementById('replayCount2').textContent = `Nghe l·∫°i: ${seekCount2} l·∫ßn`;
        } else {
            seekCount4++;
            const logEntry = `Part 4 - L·∫ßn ${seekCount4}: T·ª´ ${formatTime(lastPos)} ‚Üí ${formatTime(currentPos)}`;
            replayLog4.push(logEntry);
            document.getElementById('replayCount4').textContent = `Nghe l·∫°i: ${seekCount4} l·∫ßn`;
        }
    }
}

function formatTime(seconds) {
    if (isNaN(seconds)) return '00:00';
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
}

// ========== N·ªòP B√ÄI ==========
async function submitTest() {
    const unanswered = 12 - Object.keys(answers).length;
    if (unanswered > 0) {
        if (!confirm(`B·∫°n c√≤n ${unanswered} c√¢u ch∆∞a tr·∫£ l·ªùi. N·ªôp b√†i?`)) return;
    }
    
    if (audio2) audio2.pause();
    if (audio4) audio4.pause();
    
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<div class="spinner"></div> <span>ƒêang x·ª≠ l√Ω...</span>';
    
    let correctCount = 0;
    let wrongQuestions = [];

    Object.keys(correctAnswers).forEach(q => {
        const qNum = parseInt(q);
        const userAnswer = answers[qNum];
        const correctAns = correctAnswers[qNum];
        
        if (userAnswer && userAnswer.toUpperCase() === correctAns.toUpperCase()) {
            correctCount++;
        } else {
            wrongQuestions.push(qNum);
        }
    });

    const totalScore = Math.round((correctCount / 12) * 100);
    const endTime = new Date();
    const timeUsed = Math.round((endTime - startTime) / 60000);
    
    const allReplayLogs = [...replayLog2, ...replayLog4];
    
    const dataToSend = {
        timestamp: new Date().toLocaleString('vi-VN', { timeZone: 'Asia/Ho_Chi_Minh' }),
        studentCode: studentInfo.code,
        weekNumber: WEEK_NUMBER,
        score: totalScore,
        correctAnswers: correctCount,
        wrongQuestions: wrongQuestions.join(', ') || 'Kh√¥ng c√≥',
        timeUsed: timeUsed + ' ph√∫t',
        replayCountPart2: seekCount2,
        replayCountPart4: seekCount4,
        replayLog: allReplayLogs.join(' | '),
        answers: JSON.stringify(answers)
    };
    
    try {
        await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dataToSend)
        });
    } catch (error) {
        console.error('L·ªói g·ª≠i d·ªØ li·ªáu:', error);
    }
    
    showResults(correctCount, totalScore, timeUsed, wrongQuestions);
}

// ========== HI·ªÇN TH·ªä K·∫æT QU·∫¢ ==========
function showResults(correctCount, totalScore, timeUsed, wrongQuestions) {
    document.getElementById('testScreen').classList.add('hidden');
    document.getElementById('resultScreen').classList.remove('hidden');
    
    document.getElementById('resultScore').textContent = totalScore + '%';
    document.getElementById('resultCorrect').textContent = correctCount + '/12';
    document.getElementById('resultTime').textContent = timeUsed + ' ph√∫t';
    document.getElementById('wrongList').textContent = wrongQuestions.length > 0 ? 
        `C√¢u s·ªë: ${wrongQuestions.join(', ')}` : 'Kh√¥ng c√≥ c√¢u sai - Ho√†n h·∫£o! üéâ';
    
    let replayLogHtml = `<p class="font-semibold mb-2">Part 2: ${seekCount2} l·∫ßn | Part 4: ${seekCount4} l·∫ßn</p>`;
    if (replayLog2.length > 0) {
        replayLogHtml += '<div class="mb-2"><p class="font-semibold text-blue-700">Part 2:</p>';
        replayLog2.forEach(log => replayLogHtml += `<p>‚Ä¢ ${log}</p>`);
        replayLogHtml += '</div>';
    }
    if (replayLog4.length > 0) {
        replayLogHtml += '<div><p class="font-semibold text-purple-700">Part 4:</p>';
        replayLog4.forEach(log => replayLogHtml += `<p>‚Ä¢ ${log}</p>`);
        replayLogHtml += '</div>';
    }
    if (replayLog2.length === 0 && replayLog4.length === 0) {
        replayLogHtml = '<p>Kh√¥ng nghe l·∫°i</p>';
    }
    
    document.getElementById('resultReplayLog').innerHTML = replayLogHtml;
    
    // Hi·ªÉn th·ªã l·∫°i to√†n b·ªô b√†i l√†m
    const reviewContainer = document.getElementById('reviewContainer');
    let html = '';
    
    // Part 2 Review
    html += '<div class="mb-8"><h4 class="text-xl font-bold text-blue-700 mb-4">Part 2 - Family Holiday</h4>';
    PART2_CONFIG.questions.forEach((q) => {
        const userAnswer = answers[q.num];
        const correctAns = correctAnswers[q.num];
        const isCorrect = userAnswer && userAnswer.toUpperCase() === correctAns.toUpperCase();
        const bgClass = isCorrect ? 'correct-answer' : 'wrong-answer';
        
        html += `
        <div class="border-2 ${bgClass} rounded-xl p-6 mb-4">
            <div class="flex gap-4">
                <div class="flex-shrink-0">
                    <div class="w-10 h-10 ${isCorrect ? 'bg-green-600' : 'bg-red-600'} text-white rounded-full flex items-center justify-center font-bold">
                        ${q.num}
                    </div>
                </div>
                <div class="flex-1">
                    <p class="text-gray-800 mb-2 text-lg font-semibold">${q.text}</p>
                    <p class="text-gray-700"><span class="font-semibold">C√¢u tr·∫£ l·ªùi c·ªßa b·∫°n:</span> <span class="${isCorrect ? 'text-green-700 font-bold' : 'text-red-700 font-bold'}">${userAnswer || '(Kh√¥ng tr·∫£ l·ªùi)'}</span></p>
                    ${!isCorrect ? `<p class="text-gray-700 mt-1"><span class="font-semibold">ƒê√°p √°n ƒë√∫ng:</span> <span class="text-green-700 font-bold">${correctAns}</span></p>` : ''}
                </div>
            </div>
        </div>
        `;
    });
    html += '</div>';
    
    // Part 4 Review
    html += '<div><h4 class="text-xl font-bold text-purple-700 mb-4">Part 4 - Interview with Tyler Williams</h4>';
    PART4_CONFIG.questions.forEach((q) => {
        const userAnswer = answers[q.num];
        const correctAns = correctAnswers[q.num];
        const isCorrect = userAnswer && userAnswer.toUpperCase() === correctAns.toUpperCase();
        const bgClass = isCorrect ? 'correct-answer' : 'wrong-answer';
        
        html += `
        <div class="border-2 ${bgClass} rounded-xl p-6 mb-4">
            <div class="flex gap-4">
                <div class="flex-shrink-0">
                    <div class="w-10 h-10 ${isCorrect ? 'bg-green-600' : 'bg-red-600'} text-white rounded-full flex items-center justify-center font-bold">
                        ${q.num}
                    </div>
                </div>
                <div class="flex-1">
                    <p class="text-gray-800 mb-2 text-lg font-semibold">${q.text}</p>
                    <p class="text-gray-700"><span class="font-semibold">C√¢u tr·∫£ l·ªùi c·ªßa b·∫°n:</span> <span class="${isCorrect ? 'text-green-700 font-bold' : 'text-red-700 font-bold'}">${userAnswer || '(Kh√¥ng tr·∫£ l·ªùi)'}</span></p>
                    ${!isCorrect ? `<p class="text-gray-700 mt-1"><span class="font-semibold">ƒê√°p √°n ƒë√∫ng:</span> <span class="text-green-700 font-bold">${correctAns}</span></p>` : ''}
                </div>
            </div>
        </div>
        `;
    });
    html += '</div>';
    
    reviewContainer.innerHTML = html;
}
</script>

</body>
</html>